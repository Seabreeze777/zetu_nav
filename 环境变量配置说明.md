# 🔧 环境变量配置说明

## 📋 关于环境变量的三个重要问题

### ❓ 问题1：为什么需要创建.env文件？项目里不是有吗？

**答案：`.env` 文件不会被打包，也不应该被提交到Git！**

#### 原因详解：

1. **安全性** 🔒
   - `.env` 文件包含敏感信息：数据库密码、API密钥、JWT密钥等
   - 如果提交到Git，任何能访问代码的人都能看到这些密钥
   - 这会导致严重的安全风险！

2. **环境隔离** 🌍
   - 开发环境用本地数据库：`localhost:3306`
   - 生产环境用服务器数据库：`服务器IP:3306`
   - 如果只有一个配置，无法同时满足两个环境

3. **Next.js构建机制** ⚙️
   - 环境变量在 **构建时（npm run build）** 被读取
   - 变量值会被**注入到编译后的代码**中
   - 但 `.env` 文件本身**不会被复制到** `.next/` 构建目录
   - 所以部署时必须在服务器上单独创建

---

### ❓ 问题2：如何区分开发环境和生产环境配置？

**答案：使用 `.env.development` 和 `.env.production`**

#### Next.js环境变量加载优先级：

```
运行 npm run dev（开发）：
  ├─ 优先读取 .env.development.local（不存在则跳过）
  ├─ 其次读取 .env.development ✅（开发环境配置）
  ├─ 再读取 .env.local
  └─ 最后读取 .env

运行 npm run build + npm run start（生产）：
  ├─ 优先读取 .env.production.local（不存在则跳过）
  ├─ 其次读取 .env.production ✅（生产环境配置）
  ├─ 再读取 .env.local
  └─ 最后读取 .env
```

---

### ❓ 问题3：NEXT_PUBLIC_SITE_URL 需要改吗？

**答案：需要改！而且开发和生产环境应该不同。**

#### 用途说明：

- `NEXT_PUBLIC_` 前缀的变量会暴露到**浏览器端**（客户端可访问）
- `NEXT_PUBLIC_SITE_URL` 用于：
  - 生成网站的完整URL（SEO、元标签）
  - API请求的基础URL
  - 社交分享链接
  - Sitemap生成

#### 配置示例：

**开发环境（.env.development）：**
```bash
NEXT_PUBLIC_SITE_URL="http://localhost:3000"
```

**生产环境（.env.production）：**
```bash
NEXT_PUBLIC_SITE_URL="https://你的域名.com"
```

---

## 📁 项目配置文件结构

```
项目根目录/
├── .env.example          ← 模板文件（提交到Git）
├── .env.development      ← 开发环境配置（提交到Git，不含敏感信息）
├── .env.production       ← 生产环境配置模板（提交到Git，不含敏感信息）
├── .env                  ← 本地实际配置（不提交，.gitignore排除）
└── .env.local            ← 本地覆盖配置（不提交，.gitignore排除）
```

---

## 🚀 本地开发配置

### 第一步：复制模板

在项目根目录创建 `.env.development` 文件：

```bash
# 开发环境配置
# 本地开发时使用

# 数据库配置（本地MySQL）
DATABASE_URL="mysql://root:你的本地密码@localhost:3306/navigation_db"

# JWT密钥（开发环境可以简单一点）
JWT_SECRET="dev-secret-key-for-development-only"

# 腾讯云COS配置（开发环境 - 可以和生产用同一个）
COS_SECRET_ID="你的腾讯云SecretId"
COS_SECRET_KEY="你的腾讯云SecretKey"
COS_BUCKET="你的存储桶名称"
COS_REGION="ap-beijing"

# 环境标识
NODE_ENV="development"

# 管理员默认密码
ADMIN_DEFAULT_PASSWORD="Admin@123456"

# 本地开发端口
PORT=3000

# 网站URL（开发环境）
NEXT_PUBLIC_SITE_URL="http://localhost:3000"
```

### 第二步：启动开发服务器

```bash
npm run dev
```

Next.js会自动读取 `.env.development` 文件。

---

## 🌐 服务器部署配置

### 方法A：使用 .env.production（推荐）

#### 1. 在服务器创建文件

SSH连接到服务器，在项目目录创建 `.env.production`：

```bash
cd /www/wwwroot/你的项目目录
nano .env.production
```

#### 2. 填入生产环境配置

```bash
# 生产环境配置
# 部署到服务器时使用

# 数据库配置（服务器MySQL）
DATABASE_URL="mysql://数据库用户名:数据库密码@服务器内网IP:3306/数据库名"

# JWT密钥（生产环境必须强随机！）
# 生成方法：openssl rand -base64 64
JWT_SECRET="这里粘贴生成的超长随机密钥"

# 腾讯云COS配置（生产环境）
COS_SECRET_ID="你的腾讯云SecretId"
COS_SECRET_KEY="你的腾讯云SecretKey"
COS_BUCKET="你的生产环境存储桶"
COS_REGION="ap-beijing"

# 环境标识（重要！）
NODE_ENV="production"

# 管理员默认密码
ADMIN_DEFAULT_PASSWORD="Admin@123456"

# 生产端口
PORT=3000

# 网站URL（改成你的真实域名！）
NEXT_PUBLIC_SITE_URL="https://你的域名.com"
```

#### 3. 保存并构建

```bash
# 保存文件后（Ctrl+X, Y, Enter）

# 构建项目（会读取.env.production）
npm run build

# 启动生产服务器
npm run start
# 或使用PM2
pm2 start npm --name "zetu" -- start
```

---

### 方法B：使用 .env（也可以）

如果你不想创建 `.env.production`，可以直接创建 `.env` 文件，内容相同。

但使用 `.env.production` 更规范，便于区分环境。

---

## 🔐 生成安全的JWT密钥

### Windows PowerShell

```powershell
# 生成64位随机密钥
-join ((65..90) + (97..122) + (48..57) + (33,35,36,37,38,42,43,45,61) | Get-Random -Count 64 | % {[char]$_})
```

### Linux / Mac / Git Bash

```bash
# 生成Base64编码的64字节随机密钥
openssl rand -base64 64
```

**重要**：复制生成的密钥到 `JWT_SECRET` 配置项！

---

## ⚠️ 安全检查清单

部署前请确保：

- [ ] `.env` 和 `.env.local` 已添加到 `.gitignore`（已配置）
- [ ] 生产环境的 `JWT_SECRET` 已改为强随机密钥（不能用默认值！）
- [ ] 数据库密码是强密码
- [ ] `NEXT_PUBLIC_SITE_URL` 已改为真实域名
- [ ] `.env.production` 文件权限设置为 `600`（只有owner可读写）

设置文件权限（Linux）：

```bash
chmod 600 .env.production
```

---

## 🔍 调试环境变量

### 查看当前加载的环境变量

创建测试页面 `src/app/test-env/page.tsx`：

```typescript
export default function TestEnvPage() {
  return (
    <div style={{ padding: '20px' }}>
      <h1>环境变量测试</h1>
      <pre>
        NODE_ENV: {process.env.NODE_ENV}
        {'\n'}
        NEXT_PUBLIC_SITE_URL: {process.env.NEXT_PUBLIC_SITE_URL}
        {'\n'}
        DATABASE_URL: {process.env.DATABASE_URL ? '已配置 ✅' : '未配置 ❌'}
        {'\n'}
        JWT_SECRET: {process.env.JWT_SECRET ? '已配置 ✅' : '未配置 ❌'}
        {'\n'}
        COS配置: {process.env.COS_SECRET_ID ? '已配置 ✅' : '未配置 ❌'}
      </pre>
    </div>
  )
}
```

访问 `http://localhost:3000/test-env` 查看。

**⚠️ 部署后删除此测试页面！**

---

## 📝 总结

| 环境 | 配置文件 | 用途 | 是否提交Git |
|------|---------|------|------------|
| 开发 | `.env.development` | 本地开发配置 | ✅ 可以（不含敏感信息） |
| 生产 | `.env.production` | 服务器部署配置 | ✅ 可以（作为模板） |
| 本地覆盖 | `.env.local` | 覆盖其他配置 | ❌ 不提交 |
| 实际配置 | `.env` | 通用配置 | ❌ 不提交 |
| 模板 | `.env.example` | 配置示例 | ✅ 提交 |

---

## 🎯 快速配置指令

### 本地开发（首次配置）

```bash
# 1. 复制模板
cp .env.example .env.development

# 2. 编辑配置
nano .env.development
# 填入你的本地数据库信息、COS配置等

# 3. 启动开发服务器
npm run dev
```

### 服务器部署（首次配置）

```bash
# SSH连接到服务器后

# 1. 进入项目目录
cd /www/wwwroot/你的项目

# 2. 创建生产配置
nano .env.production
# 填入服务器数据库、域名等信息

# 3. 设置文件权限
chmod 600 .env.production

# 4. 构建项目
npm run build

# 5. 启动
pm2 start npm --name zetu -- start
```

---

**配置完成！** 🎉

如有疑问，参考 `部署指南-宝塔面板.md` 详细说明。

