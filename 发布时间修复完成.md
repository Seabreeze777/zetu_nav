# âœ… æ–‡ç« å‘å¸ƒæ—¶é—´ä¿®å¤å®Œæˆ

## ğŸ” é—®é¢˜åŸå› 

### ä¹‹å‰çš„é€»è¾‘ï¼ˆé”™è¯¯ï¼‰ï¼š

```typescript
// âŒ æ¯æ¬¡ä¿å­˜éƒ½é‡ç½®å‘å¸ƒæ—¶é—´
publishedAt: isPublished ? new Date() : null
```

**é—®é¢˜ï¼š**
1. ç¼–è¾‘å·²å‘å¸ƒçš„æ–‡ç« æ—¶ï¼Œä¼šé‡ç½®å‘å¸ƒæ—¶é—´ä¸ºå½“å‰æ—¶é—´
2. å¯¼è‡´æ–‡ç« çš„å®é™…å‘å¸ƒæ—¶é—´ä¸¢å¤±
3. "æœ€æ–°å‘å¸ƒ"æ’åºä¼šé”™è¯¯åœ°æ˜¾ç¤ºç¼–è¾‘è¿‡çš„æ–‡ç« 

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ­£ç¡®çš„é€»è¾‘ï¼š

```typescript
// âœ… æ™ºèƒ½åˆ¤æ–­å‘å¸ƒæ—¶é—´
let publishedAt: Date | null = before?.publishedAt || null

if (isPublished && !before?.isPublished) {
  // ä»æœªå‘å¸ƒå˜ä¸ºå‘å¸ƒï¼šè®¾ç½®ä¸ºå½“å‰æ—¶é—´
  publishedAt = new Date()
} else if (!isPublished) {
  // å–æ¶ˆå‘å¸ƒï¼šè®¾ç½®ä¸º null
  publishedAt = null
}
// å¦‚æœå·²ç»å‘å¸ƒè¿‡ï¼Œä¿æŒåŸæ¥çš„æ—¶é—´ä¸å˜
```

---

## ğŸ“‹ ä¿®å¤å†…å®¹

### ä¿®å¤æ–‡ä»¶ï¼š`src/app/api/admin/articles/[id]/route.ts`

#### 1. PATCH æ–¹æ³•ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰

**ä½ç½®ï¼š** ç¬¬ 39-49 è¡Œ

**ä¿®æ”¹å‰ï¼š**
```typescript
// âŒ ç®€å•ç²—æš´ï¼Œæ¯æ¬¡éƒ½é‡ç½®
if (body.isPublished !== undefined) {
  body.publishedAt = body.isPublished ? new Date() : null
}
```

**ä¿®æ”¹åï¼š**
```typescript
// âœ… æ™ºèƒ½åˆ¤æ–­ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡å‘å¸ƒæ—¶è®¾ç½®
if (body.isPublished !== undefined) {
  if (body.isPublished && !before?.isPublished) {
    // ä»è‰ç¨¿å˜ä¸ºå‘å¸ƒï¼šè®¾ç½®ä¸ºå½“å‰æ—¶é—´
    body.publishedAt = new Date()
  } else if (!body.isPublished) {
    // ä»å‘å¸ƒå˜ä¸ºè‰ç¨¿ï¼šæ¸…ç©ºæ—¶é—´
    body.publishedAt = null
  }
  // å¦‚æœå·²ç»å‘å¸ƒè¿‡ï¼Œä¸ä¿®æ”¹æ—¶é—´
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- æ–‡ç« åˆ—è¡¨é¡µçš„å‘å¸ƒçŠ¶æ€ toggle å¼€å…³

---

#### 2. PUT æ–¹æ³•ï¼ˆå®Œæ•´æ›´æ–°ï¼‰

**ä½ç½®ï¼š** ç¬¬ 201-211 è¡Œ

**ä¿®æ”¹å‰ï¼š**
```typescript
// âŒ æ¯æ¬¡ä¿å­˜éƒ½é‡ç½®
data: {
  // ...å…¶ä»–å­—æ®µ
  publishedAt: isPublished ? new Date() : null,
}
```

**ä¿®æ”¹åï¼š**
```typescript
// âœ… è·å–æ›´æ–°å‰çš„æ•°æ®
const before = await prisma.article.findUnique({
  where: { id: articleId },
})

// âœ… æ™ºèƒ½è®¡ç®—å‘å¸ƒæ—¶é—´
let publishedAt: Date | null = before?.publishedAt || null

if (isPublished && !before?.isPublished) {
  // ä»æœªå‘å¸ƒå˜ä¸ºå‘å¸ƒï¼šè®¾ç½®ä¸ºå½“å‰æ—¶é—´
  publishedAt = new Date()
} else if (!isPublished) {
  // å–æ¶ˆå‘å¸ƒï¼šè®¾ç½®ä¸º null
  publishedAt = null
}
// å¦‚æœå·²ç»å‘å¸ƒè¿‡ï¼Œä¿æŒåŸæ¥çš„æ—¶é—´ä¸å˜

data: {
  // ...å…¶ä»–å­—æ®µ
  publishedAt,
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- æ–‡ç« ç¼–è¾‘é¡µçš„"ä¿å­˜ä¿®æ”¹"æŒ‰é’®

---

## ğŸ¯ é€»è¾‘åˆ¤æ–­è¡¨

| æ“ä½œå‰çŠ¶æ€ | æ“ä½œåçŠ¶æ€ | publishedAt å˜åŒ– |
|-----------|-----------|-----------------|
| è‰ç¨¿ (æœªå‘å¸ƒ) | è‰ç¨¿ (æœªå‘å¸ƒ) | `null` â†’ `null` (ä¸å˜) |
| è‰ç¨¿ (æœªå‘å¸ƒ) | å·²å‘å¸ƒ | `null` â†’ `new Date()` (è®¾ç½®å½“å‰æ—¶é—´) âœ… |
| å·²å‘å¸ƒ | å·²å‘å¸ƒ | `2025-01-10` â†’ `2025-01-10` (ä¿æŒä¸å˜) âœ… |
| å·²å‘å¸ƒ | è‰ç¨¿ (å–æ¶ˆå‘å¸ƒ) | `2025-01-10` â†’ `null` (æ¸…ç©º) |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1ï¼šæ–°å»ºå¹¶å‘å¸ƒæ–‡ç« 

```
1. è¿›å…¥ï¼šhttp://localhost:3000/admin/articles/new
2. å¡«å†™æ ‡é¢˜ã€å†…å®¹
3. å‹¾é€‰"ç«‹å³å‘å¸ƒ"
4. ç‚¹å‡»"åˆ›å»ºæ–‡ç« "
5. æ£€æŸ¥æ•°æ®åº“ï¼špublished_at å­—æ®µåº”è¯¥æœ‰æ—¶é—´
```

**é¢„æœŸç»“æœï¼š**
```sql
SELECT id, title, is_published, published_at FROM articles WHERE id = <æ–°æ–‡ç« ID>;

id | title    | is_published | published_at
---|----------|--------------|------------------------
1  | æµ‹è¯•æ–‡ç«   | 1            | 2025-01-10 14:30:00  âœ…
```

---

### æµ‹è¯• 2ï¼šç¼–è¾‘å·²å‘å¸ƒçš„æ–‡ç« 

```
1. ç¼–è¾‘ä¸€ç¯‡å·²å‘å¸ƒçš„æ–‡ç« 
2. ä¿®æ”¹æ ‡é¢˜æˆ–å†…å®¹
3. ä¿æŒ"å·²å‘å¸ƒ"çŠ¶æ€
4. ç‚¹å‡»"ä¿å­˜ä¿®æ”¹"
5. æ£€æŸ¥æ•°æ®åº“ï¼špublished_at åº”è¯¥ä¿æŒä¸å˜
```

**é¢„æœŸç»“æœï¼š**
```sql
-- ä¿®æ”¹å‰
published_at: 2025-01-10 14:30:00

-- ä¿®æ”¹å
published_at: 2025-01-10 14:30:00  âœ… (ä¸å˜)
```

---

### æµ‹è¯• 3ï¼šä»è‰ç¨¿å‘å¸ƒæ–‡ç« 

```
1. åˆ›å»ºä¸€ç¯‡è‰ç¨¿æ–‡ç« ï¼ˆä¸å‹¾é€‰"ç«‹å³å‘å¸ƒ"ï¼‰
2. ä¿å­˜åï¼Œæ£€æŸ¥æ•°æ®åº“ï¼špublished_at = NULL
3. ç¼–è¾‘è¯¥æ–‡ç« ï¼Œå‹¾é€‰"å·²å‘å¸ƒ"
4. ç‚¹å‡»"ä¿å­˜ä¿®æ”¹"
5. æ£€æŸ¥æ•°æ®åº“ï¼špublished_at åº”è¯¥æ˜¯å½“å‰æ—¶é—´
```

**é¢„æœŸç»“æœï¼š**
```sql
-- è‰ç¨¿çŠ¶æ€
published_at: NULL

-- å‘å¸ƒå
published_at: 2025-01-10 15:00:00  âœ… (è®¾ç½®ä¸ºå½“å‰æ—¶é—´)
```

---

### æµ‹è¯• 4ï¼šä»æ–‡ç« åˆ—è¡¨åˆ‡æ¢å‘å¸ƒçŠ¶æ€

```
1. è¿›å…¥ï¼šhttp://localhost:3000/admin/articles
2. æ‰¾åˆ°ä¸€ç¯‡è‰ç¨¿æ–‡ç« 
3. ç‚¹å‡» toggle å¼€å…³ï¼Œåˆ‡æ¢ä¸º"å·²å‘å¸ƒ"
4. æ£€æŸ¥æ•°æ®åº“ï¼špublished_at åº”è¯¥æ˜¯å½“å‰æ—¶é—´
5. å†æ¬¡ç‚¹å‡» toggleï¼Œåˆ‡æ¢ä¸º"è‰ç¨¿"
6. æ£€æŸ¥æ•°æ®åº“ï¼špublished_at åº”è¯¥å˜ä¸º NULL
```

---

### æµ‹è¯• 5ï¼šå¤šæ¬¡ç¼–è¾‘å·²å‘å¸ƒçš„æ–‡ç« 

```
1. å‘å¸ƒä¸€ç¯‡æ–‡ç« ï¼ˆpublished_at: 2025-01-10 10:00ï¼‰
2. ç¼–è¾‘å¹¶ä¿å­˜ 5 æ¬¡
3. æ£€æŸ¥æ•°æ®åº“ï¼špublished_at åº”è¯¥å§‹ç»ˆæ˜¯ 2025-01-10 10:00
```

**é¢„æœŸç»“æœï¼š**
```
ç¼–è¾‘ç¬¬ 1 æ¬¡ï¼špublished_at = 2025-01-10 10:00 âœ…
ç¼–è¾‘ç¬¬ 2 æ¬¡ï¼špublished_at = 2025-01-10 10:00 âœ…
ç¼–è¾‘ç¬¬ 3 æ¬¡ï¼špublished_at = 2025-01-10 10:00 âœ…
ç¼–è¾‘ç¬¬ 4 æ¬¡ï¼špublished_at = 2025-01-10 10:00 âœ…
ç¼–è¾‘ç¬¬ 5 æ¬¡ï¼špublished_at = 2025-01-10 10:00 âœ…
```

---

## ğŸ“Š æ•°æ®åº“éªŒè¯

### æ£€æŸ¥å•ç¯‡æ–‡ç« 

```sql
SELECT 
  id,
  title,
  is_published,
  published_at,
  created_at,
  updated_at
FROM articles
WHERE id = <æ–‡ç« ID>;
```

### æ£€æŸ¥æ‰€æœ‰æ–‡ç« çš„å‘å¸ƒæ—¶é—´

```sql
SELECT 
  id,
  title,
  is_published,
  published_at,
  CASE 
    WHEN is_published = 1 AND published_at IS NULL THEN 'âŒ å¼‚å¸¸ï¼šå·²å‘å¸ƒä½†æ— æ—¶é—´'
    WHEN is_published = 0 AND published_at IS NOT NULL THEN 'âš ï¸ è­¦å‘Šï¼šè‰ç¨¿ä½†æœ‰æ—¶é—´'
    WHEN is_published = 1 AND published_at IS NOT NULL THEN 'âœ… æ­£å¸¸'
    WHEN is_published = 0 AND published_at IS NULL THEN 'âœ… æ­£å¸¸'
  END as status
FROM articles
ORDER BY created_at DESC;
```

---

## ğŸ”§ ä¿®å¤å·²æœ‰æ•°æ®

å¦‚æœä¹‹å‰å·²ç»å‘å¸ƒçš„æ–‡ç« ï¼Œå‘å¸ƒæ—¶é—´è¢«é”™è¯¯é‡ç½®ï¼Œå¯ä»¥æ‰‹åŠ¨ä¿®å¤ï¼š

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨åˆ›å»ºæ—¶é—´ä½œä¸ºå‘å¸ƒæ—¶é—´

```sql
UPDATE articles
SET published_at = created_at
WHERE is_published = 1 AND published_at IS NULL;
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ›´æ–°æ—¶é—´ä½œä¸ºå‘å¸ƒæ—¶é—´

```sql
UPDATE articles
SET published_at = updated_at
WHERE is_published = 1 AND published_at IS NULL;
```

### æ–¹æ¡ˆ 3ï¼šæ‰‹åŠ¨è®¾ç½®ç‰¹å®šæ–‡ç« çš„å‘å¸ƒæ—¶é—´

```sql
UPDATE articles
SET published_at = '2025-01-10 14:30:00'
WHERE id = <æ–‡ç« ID>;
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘å¸ƒæ—¶é—´ä¸ä¼šè‡ªåŠ¨æ›´æ–°

ä¸€æ—¦æ–‡ç« é¦–æ¬¡å‘å¸ƒï¼Œ`published_at` å°±å›ºå®šäº†ï¼Œå³ä½¿ï¼š
- ä¿®æ”¹æ–‡ç« å†…å®¹
- ä¿®æ”¹æ ‡é¢˜ã€æè¿°
- ä¿®æ”¹åˆ†ç±»ã€æ ‡ç­¾

**é™¤éï¼š**
- å…ˆå–æ¶ˆå‘å¸ƒï¼ˆå˜ä¸ºè‰ç¨¿ï¼‰
- å†é‡æ–°å‘å¸ƒ

è¿™æ—¶ä¼šè®¾ç½®æ–°çš„å‘å¸ƒæ—¶é—´ã€‚

---

### 2. æ’åºé€»è¾‘

"æœ€æ–°å‘å¸ƒ"æ’åºä½¿ç”¨ `published_at`ï¼š

```typescript
sorted.sort((a, b) => {
  const dateA = new Date(a.publishedAt || 0).getTime()
  const dateB = new Date(b.publishedAt || 0).getTime()
  return dateB - dateA
})
```

æ‰€ä»¥ç¼–è¾‘æ–‡ç« ä¸ä¼šå½±å“æ’åºï¼Œåªæœ‰é¦–æ¬¡å‘å¸ƒæ—¶é—´æ‰å†³å®šæ’åºã€‚

---

### 3. è‰ç¨¿æ–‡ç« 

è‰ç¨¿æ–‡ç« çš„ `published_at` å§‹ç»ˆä¸º `NULL`ï¼š
- ä¸ä¼šåœ¨å‰å°æ˜¾ç¤º
- ä¸ä¼šè¢«è®¡å…¥ç»Ÿè®¡
- ä¸ä¼šå‡ºç°åœ¨æ’åºä¸­

---

## ğŸ“ æ€»ç»“

| ä¿®å¤é¡¹ | æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ |
|--------|------|------|------|
| PATCH æ–¹æ³• | `src/app/api/admin/articles/[id]/route.ts` | 39-49 | âœ… |
| PUT æ–¹æ³• | `src/app/api/admin/articles/[id]/route.ts` | 201-211 | âœ… |

**æ ¸å¿ƒåŸåˆ™ï¼š**
- âœ… é¦–æ¬¡å‘å¸ƒï¼šè®¾ç½®å½“å‰æ—¶é—´
- âœ… å·²å‘å¸ƒï¼šä¿æŒåŸæ—¶é—´ä¸å˜
- âœ… å–æ¶ˆå‘å¸ƒï¼šæ¸…ç©ºæ—¶é—´
- âœ… è‰ç¨¿ï¼šæ—¶é—´ä¸º NULL

**å½±å“èŒƒå›´ï¼š**
- âœ… æ–°å»ºæ–‡ç« 
- âœ… ç¼–è¾‘æ–‡ç« 
- âœ… åˆ‡æ¢å‘å¸ƒçŠ¶æ€ï¼ˆtoggleï¼‰
- âœ… "æœ€æ–°å‘å¸ƒ"æ’åº

**æ— å‰¯ä½œç”¨ï¼š**
- âœ… æ—  Lint é”™è¯¯
- âœ… æ— éœ€æ•°æ®åº“è¿ç§»
- âœ… å‘åå…¼å®¹

**ç°åœ¨å‘å¸ƒæ—¶é—´çš„é€»è¾‘æ˜¯æ­£ç¡®çš„äº†ï¼** ğŸ‰

