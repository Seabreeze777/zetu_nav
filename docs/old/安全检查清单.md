# 🔒 安全检查清单

本文档列出了项目的安全措施和建议检查项。

---

## ✅ 已实现的安全措施

### 1. 身份认证

#### JWT Token认证
- ✅ 使用 `jsonwebtoken` 生成和验证token
- ✅ Token存储在HttpOnly Cookie中（防XSS）
- ✅ Token有效期24小时
- ✅ 实现了 `verifyAuth` 中间件统一验证

**位置：** `src/lib/auth.ts`

#### 密码安全
- ✅ 使用 `bcryptjs` 加密密码（salt rounds: 10）
- ✅ 密码不在API响应中返回
- ✅ 登录失败不透露具体信息（用户名或密码错误）

---

### 2. 权限控制

#### 管理员权限
所有后台API都已添加权限验证：

✅ **后台管理API** (`/api/admin/*`)
- 网站管理：`/api/admin/websites/*`
- 文章管理：`/api/admin/articles/*`
- 分类管理：`/api/admin/categories/*`
- 标签管理：`/api/admin/tags/*`
- 用户管理：`/api/admin/users/*`

**验证逻辑：**
```typescript
const user = await verifyAuth(request);
if (!user || user.role !== 'ADMIN') {
  return NextResponse.json({ error: '无权限' }, { status: 403 });
}
```

#### 用户权限
✅ **用户功能API**
- 收藏功能：`/api/favorites/*` - 需登录
- 个人设置：`/api/user/*` - 需登录
- 修改密码：验证旧密码

---

### 3. 数据验证

#### 输入验证
✅ 所有API都进行了基本验证：
- 必填字段检查
- 数据类型验证
- 字符串长度限制
- URL格式验证（邮箱、网址）

#### SQL注入防护
✅ 使用Prisma ORM
- 自动参数化查询
- 防止SQL注入攻击

---

### 4. 错误处理

✅ **统一错误响应**
```typescript
try {
  // 业务逻辑
} catch (error) {
  console.error('操作失败:', error);
  return NextResponse.json({ error: '操作失败' }, { status: 500 });
}
```

✅ **不泄露敏感信息**
- 生产环境不返回详细错误堆栈
- 统一错误消息
- 错误日志记录

---

### 5. 数据库安全

✅ **关系完整性**
- 使用外键约束
- 级联删除（`onDelete: Cascade`）
- 唯一性约束

✅ **删除保护**
- 删除分类前检查关联内容
- 删除标签前检查文章关联
- 用户不能删除自己

---

## 🔍 需要检查的项目

### 生产环境部署前

- [ ] 修改默认 `JWT_SECRET` 为强随机字符串
- [ ] 修改默认管理员密码
- [ ] 配置HTTPS证书
- [ ] 限制数据库访问IP白名单
- [ ] 设置防火墙规则
- [ ] 配置CORS策略（如需要）
- [ ] 启用Rate Limiting（API限流）
- [ ] 配置日志监控
- [ ] 定期备份数据库

### 代码审查

- [ ] 检查所有用户输入点
- [ ] 验证文件上传（如实现）
- [ ] 检查敏感数据处理
- [ ] 审查权限控制逻辑
- [ ] 测试SQL注入漏洞
- [ ] 测试XSS攻击
- [ ] 测试CSRF攻击（Cookie SameSite）

---

## 🛡️ 安全建议

### 1. 环境变量管理

**不要：**
```typescript
// ❌ 硬编码敏感信息
const secret = 'my-secret-key';
const dbUrl = 'mysql://root:password@localhost/db';
```

**应该：**
```typescript
// ✅ 使用环境变量
const secret = process.env.JWT_SECRET;
const dbUrl = process.env.DATABASE_URL;
```

### 2. Cookie安全

当前配置（`src/lib/auth.ts`）：
```typescript
{
  httpOnly: true,    // 防止JavaScript访问
  secure: process.env.NODE_ENV === 'production', // HTTPS only
  sameSite: 'lax',   // CSRF防护
  maxAge: 86400      // 24小时
}
```

**生产环境建议：**
- 使用 `sameSite: 'strict'`（更安全，但可能影响外链登录）
- 缩短token有效期（如1小时）+ 刷新token机制

### 3. 密码策略

**当前：** 最少6个字符

**建议增强：**
```typescript
// 密码强度验证
const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
// 至少8位，包含大小写字母和数字
```

### 4. Rate Limiting

**建议实现：**
```typescript
// 使用 express-rate-limit 或类似库
import rateLimit from 'express-rate-limit';

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 5, // 最多5次尝试
  message: '登录尝试次数过多，请稍后再试'
});
```

### 5. HTTPS强制

**Nginx配置：**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 其他配置...
}
```

### 6. 数据库连接

**建议：**
```env
# 使用SSL连接
DATABASE_URL="mysql://user:pass@host:3306/db?ssl=true"

# 限制连接池
DATABASE_URL="mysql://user:pass@host:3306/db?connection_limit=10"
```

---

## 🔐 数据脱敏

### 敏感数据不返回

已实现（在所有Prisma查询中）：
```typescript
// ✅ 不返回密码
select: {
  id: true,
  username: true,
  email: true,
  // password: false (默认不包含)
}
```

### 日志脱敏

**建议：**
```typescript
// ❌ 不要记录敏感信息
console.log('用户登录', { username, password });

// ✅ 脱敏处理
console.log('用户登录', { username, ip: request.ip });
```

---

## 🚨 安全事件响应

### 发现安全问题时

1. **立即行动：**
   - 修改所有密钥（JWT_SECRET、数据库密码、API密钥）
   - 检查日志，评估影响范围
   - 通知用户修改密码（如需要）

2. **修复漏洞：**
   - 紧急修复代码
   - 更新依赖包
   - 重新部署

3. **加固措施：**
   - 添加额外验证
   - 实施更严格的权限控制
   - 启用监控告警

---

## 📊 安全监控

### 建议监控指标

- 登录失败次数（检测暴力破解）
- API调用频率（检测异常流量）
- 数据库连接数（检测连接池耗尽）
- 错误率（检测攻击尝试）
- 响应时间（检测性能问题）

### 日志记录

**应该记录：**
- 登录/登出事件
- 权限拒绝事件
- 数据修改操作（审计日志）
- 系统错误

**不应记录：**
- 密码（明文或加密）
- 完整的信用卡号
- 其他敏感个人信息

---

## 🔧 定期维护

### 每周
- [ ] 检查系统日志
- [ ] 监控异常访问

### 每月
- [ ] 更新npm依赖包
- [ ] 审查用户权限
- [ ] 检查数据库备份

### 每季度
- [ ] 进行安全审计
- [ ] 更新密钥
- [ ] 渗透测试

---

## 📚 安全资源

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js安全最佳实践](https://nextjs.org/docs/pages/building-your-application/configuring/authentication)
- [Prisma安全指南](https://www.prisma.io/docs/guides/database/advanced-database-tasks/sql-injection)

---

## ✅ 总结

**当前安全等级：** 🟢 良好

**已实现的核心安全措施：**
- ✅ 密码加密存储
- ✅ JWT身份认证
- ✅ 权限控制
- ✅ SQL注入防护
- ✅ 基本输入验证
- ✅ 错误处理
- ✅ 数据脱敏

**建议改进（可选）：**
- Rate Limiting（API限流）
- 密码强度策略
- 双因素认证（2FA）
- 审计日志系统
- 入侵检测

---

**项目已具备基本的安全防护，可以安全使用！** 🎉

