// Prisma Schema - æ‹©å›¾å¯¼èˆªç½‘ç«™æ•°æ®åº“è®¾è®¡
// ç”Ÿæˆæ—¶é—´: 2025-11-05

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== å¯¼èˆªç³»ç»Ÿ ====================

// å¯¼èˆªåˆ†ç±»è¡¨ï¼ˆçƒ­é—¨æ¨èã€å¸¸ç”¨å·¥å…·ç­‰ï¼‰
model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(50)        // åˆ†ç±»åç§°
  slug        String    @unique @db.VarChar(50) // URLæ ‡è¯†ï¼ˆhot, toolsç­‰ï¼‰
  icon        String    @db.VarChar(50)        // emojiå›¾æ ‡ ğŸ”¥
  description String?   @db.VarChar(200)       // åˆ†ç±»æè¿°
  sortOrder   Int       @default(0)            // æ’åºï¼ˆè¶Šå°è¶Šé å‰ï¼‰
  cardsPerRow Int       @default(6) @map("cards_per_row") // æ¯è¡Œæ˜¾ç¤ºå‡ ä¸ªå¡ç‰‡ (4/5/6)
  displayMode String    @default("compact") @map("display_mode") @db.VarChar(20) // æ˜¾ç¤ºæ¨¡å¼ï¼šlarge(å¤§å›¾)/button(æŒ‰é’®)/compact(ç´§å‡‘)
  isActive    Boolean   @default(true) @map("is_active")  // æ˜¯å¦å¯ç”¨
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  websites    Website[]

  @@map("categories")
  @@index([sortOrder])
}

// å¯¼èˆªç½‘ç«™è¡¨
model Website {
  id            Int      @id @default(autoincrement())
  categoryId    Int      @map("category_id")
  name          String   @db.VarChar(100)       // ç½‘ç«™åç§°
  description   String?  @db.VarChar(500)       // ç½‘ç«™æè¿°
  url           String   @db.VarChar(500)       // ç½‘ç«™é“¾æ¥
  logoUrl       String?  @map("logo_url") @db.VarChar(500) // Logoå›¾ç‰‡URLï¼ˆCOSï¼‰
  actionButtons Json?    @map("action_buttons") // æ‰©å±•æŒ‰é’®é…ç½® [{text: "å…¬å¸ä»‹ç»", url: "/about"}, ...]
  sortOrder     Int      @default(0)            // æ’åº
  clickCount    Int      @default(0) @map("click_count")   // ç‚¹å‡»æ¬¡æ•°
  isActive      Boolean  @default(true) @map("is_active")  // æ˜¯å¦æ˜¾ç¤º
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tags        WebsiteTag[]
  favorites   WebsiteFavorite[]

  @@map("websites")
  @@index([categoryId])
  @@index([sortOrder])
  @@index([clickCount])
}

// ==================== æ–‡ç« ç³»ç»Ÿ ====================

// æ–‡ç« åˆ†ç±»è¡¨ï¼ˆå‰ç«¯å¼€å‘ã€åç«¯å¼€å‘ç­‰ï¼‰
model ArticleCategory {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(50)        // åˆ†ç±»åç§°
  slug        String    @unique @db.VarChar(50) // URLæ ‡è¯†
  icon        String    @db.VarChar(50)        // emojiå›¾æ ‡
  description String?   @db.VarChar(200)       // åˆ†ç±»æè¿°
  sortOrder   Int       @default(0)            // æ’åº
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  articles    Article[]

  @@map("article_categories")
  @@index([sortOrder])
}

// æ–‡ç« è¡¨
model Article {
  id          Int      @id @default(autoincrement())
  categoryId  Int      @map("category_id")
  title       String   @db.VarChar(200)       // æ–‡ç« æ ‡é¢˜
  slug        String   @unique @db.VarChar(200) // URLæ ‡è¯†
  description String?  @db.VarChar(500)       // æ–‡ç« ç®€ä»‹
  content     String   @db.Text               // æ–‡ç« å†…å®¹ï¼ˆMarkdownï¼‰
  coverImage  String?  @map("cover_image") @db.VarChar(500) // å°é¢å›¾URLï¼ˆCOSï¼‰
  author      String   @default("ç®¡ç†å‘˜") @db.VarChar(50)
  views       Int      @default(0)            // æµè§ˆæ¬¡æ•°
  readTime    Int      @default(5) @map("read_time") // é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  isFeatured  Boolean  @default(false) @map("is_featured") // æ˜¯å¦ç²¾é€‰
  isPublished Boolean  @default(true) @map("is_published")  // æ˜¯å¦å‘å¸ƒ
  publishedAt DateTime? @map("published_at")  // å‘å¸ƒæ—¶é—´
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category    ArticleCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tags        ArticleTag[]
  favorites   ArticleFavorite[]

  @@map("articles")
  @@index([categoryId])
  @@index([views])
  @@index([publishedAt])
  @@index([isFeatured])
}

// ==================== æ ‡ç­¾ç³»ç»Ÿ ====================

// æ ‡ç­¾è¡¨ï¼ˆReactã€Vueã€TypeScriptç­‰ï¼‰
model Tag {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)  // æ ‡ç­¾åç§°
  slug        String   @unique @db.VarChar(50)  // URLæ ‡è¯†
  color       String   @default("#3B82F6") @db.VarChar(20) // æ ‡ç­¾é¢œè‰²
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  websites    WebsiteTag[]
  articles    ArticleTag[]

  @@map("tags")
}

// ç½‘ç«™-æ ‡ç­¾å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šï¼‰
model WebsiteTag {
  websiteId Int @map("website_id")
  tagId     Int @map("tag_id")
  
  website   Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([websiteId, tagId])
  @@map("website_tags")
}

// æ–‡ç« -æ ‡ç­¾å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šï¼‰
model ArticleTag {
  articleId Int @map("article_id")
  tagId     Int @map("tag_id")
  
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

// ==================== ç”¨æˆ·ç³»ç»Ÿ ====================

// ç”¨æˆ·è¡¨ï¼ˆåå°ç®¡ç†å‘˜ï¼‰
model User {
  id          Int      @id @default(autoincrement())
  username    String   @unique @db.VarChar(50)   // ç”¨æˆ·å
  password    String   @db.VarChar(255)          // å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  email       String?  @unique @db.VarChar(100)  // é‚®ç®±
  nickname    String?  @db.VarChar(50)           // æ˜µç§°
  avatar      String?  @db.VarChar(500)          // å¤´åƒURLï¼ˆCOSï¼‰
  role        String   @default("admin") @db.VarChar(20) // è§’è‰²ï¼ˆadmin/editorç­‰ï¼‰
  isActive    Boolean  @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")    // æœ€åç™»å½•æ—¶é—´
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  websiteFavorites WebsiteFavorite[]
  articleFavorites ArticleFavorite[]
  uploadedMedia    Media[]
  mediaFolders     MediaFolder[]
  auditLogs        AuditLog[]

  @@map("users")
}

// ==================== åª’ä½“åº“ç³»ç»Ÿ ====================

// åª’ä½“æ–‡ä»¶å¤¹è¡¨
model MediaFolder {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)       // æ–‡ä»¶å¤¹åç§°ï¼ˆå”¯ä¸€ï¼‰
  description String?  @db.VarChar(500)               // æ–‡ä»¶å¤¹æè¿°
  sortOrder   Int      @default(0)                    // æ’åº
  createdBy   Int      @map("created_by")             // åˆ›å»ºè€…ID
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  creator     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("media_folders")
  @@index([sortOrder])
}

// åª’ä½“æ–‡ä»¶è¡¨ï¼ˆå›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰
model Media {
  id           Int      @id @default(autoincrement())
  fileName     String   @map("file_name") @db.VarChar(255)      // å­˜å‚¨çš„æ–‡ä»¶å
  originalName String   @map("original_name") @db.VarChar(255)  // åŸå§‹æ–‡ä»¶å
  fileSize     Int      @map("file_size")                       // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  mimeType     String   @map("mime_type") @db.VarChar(100)      // MIMEç±»å‹
  width        Int?                                             // å›¾ç‰‡å®½åº¦
  height       Int?                                             // å›¾ç‰‡é«˜åº¦
  url          String   @db.VarChar(500)                        // å®Œæ•´è®¿é—®URL
  cosKey       String   @map("cos_key") @db.VarChar(500)        // COSå¯¹è±¡é”®
  bucket       String   @db.VarChar(100)                        // COSå­˜å‚¨æ¡¶
  folder       String?  @db.VarChar(200)                        // æ–‡ä»¶å¤¹åˆ†ç±»ï¼ˆwebsites/articles/avatarsç­‰ï¼‰
  uploadedBy   Int      @map("uploaded_by")                     // ä¸Šä¼ è€…ID
  usedCount    Int      @default(0) @map("used_count")          // è¢«å¼•ç”¨æ¬¡æ•°
  tags         String?  @db.Text                                // æ ‡ç­¾ï¼ˆJSONæ•°ç»„ï¼‰
  description  String?  @db.VarChar(500)                        // æ–‡ä»¶æè¿°
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  uploader     User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@map("media")
  @@index([uploadedBy])
  @@index([mimeType])
  @@index([folder])
  @@index([createdAt])
}

// ==================== æ”¶è—ç³»ç»Ÿ ====================

// ç½‘ç«™æ”¶è—è¡¨
model WebsiteFavorite {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  websiteId Int      @map("website_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([userId, websiteId])
  @@map("website_favorites")
  @@index([userId])
  @@index([websiteId])
}

// æ–‡ç« æ”¶è—è¡¨
model ArticleFavorite {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  articleId Int      @map("article_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@map("article_favorites")
  @@index([userId])
  @@index([articleId])
}

// ==================== å…¨å±€é…ç½® ====================

// å…¨å±€æ‚¬æµ®æŒ‰é’®
model FloatingButton {
  id        Int      @id @default(autoincrement())
  icon      String   @db.VarChar(10)        // å›¾æ ‡ emoji æˆ–å›¾æ ‡åç§°
  label     String   @db.VarChar(50)        // æŒ‰é’®æ ‡ç­¾
  url       String   @db.VarChar(500)       // è·³è½¬é“¾æ¥
  sortOrder Int      @default(0) @map("sort_order") // æ’åº
  isActive  Boolean  @default(true) @map("is_active") // æ˜¯å¦å¯ç”¨
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("floating_buttons")
  @@index([sortOrder])
}

// ç³»ç»Ÿé…ç½®è¡¨ï¼ˆCOSã€é‚®ä»¶ç­‰å¯åœ¨åå°ç®¡ç†çš„é…ç½®ï¼‰
model SystemConfig {
  id          Int      @id @default(autoincrement())
  category    String   @db.VarChar(50)        // é…ç½®åˆ†ç±»ï¼šcos, site, emailç­‰
  key         String   @db.VarChar(100)       // é…ç½®é”®å
  value       String   @db.Text               // é…ç½®å€¼
  label       String   @db.VarChar(100)       // æ˜¾ç¤ºæ ‡ç­¾
  description String?  @db.VarChar(500)       // é…ç½®è¯´æ˜
  type        String   @default("text") @db.VarChar(20) // è¾“å…¥ç±»å‹ï¼štext, password, number, textarea
  isSecret    Boolean  @default(false) @map("is_secret") // æ˜¯å¦æ•æ„Ÿä¿¡æ¯
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([category, key])
  @@map("system_configs")
  @@index([category])
}

// é¡¶éƒ¨å¯¼èˆªèœå•
model NavigationMenu {
  id           Int               @id @default(autoincrement())
  name         String            @db.VarChar(50)        // èœå•åç§°
  href         String            @db.VarChar(500)       // è·³è½¬é“¾æ¥
  icon         String?           @db.VarChar(50)        // å›¾æ ‡ emojiï¼ˆå¯é€‰ï¼‰
  parentId     Int?              @map("parent_id")      // çˆ¶èœå•IDï¼ˆnullè¡¨ç¤ºé¡¶çº§èœå•ï¼‰
  sortOrder    Int               @default(0) @map("sort_order") // æ’åº
  isActive     Boolean           @default(true) @map("is_active") // æ˜¯å¦å¯ç”¨
  openInNewTab Boolean           @default(false) @map("open_in_new_tab") // æ˜¯å¦æ–°çª—å£æ‰“å¼€
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  parent       NavigationMenu?   @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     NavigationMenu[]  @relation("MenuHierarchy")

  @@map("navigation_menus")
  @@index([parentId])
  @@index([sortOrder])
}

// ==================== æ“ä½œæ—¥å¿—ç³»ç»Ÿ ====================

// æ“ä½œæ—¥å¿—è¡¨ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")                      // æ“ä½œäººID
  action     String   @db.VarChar(20)                      // æ“ä½œç±»å‹ï¼šCREATE, UPDATE, DELETE, LOGIN, LOGOUT
  module     String   @db.VarChar(50)                      // æ¨¡å—ï¼šWebsite, Article, User, Categoryç­‰
  targetId   Int?     @map("target_id")                    // æ“ä½œå¯¹è±¡IDï¼ˆå¦‚æœé€‚ç”¨ï¼‰
  targetName String?  @map("target_name") @db.VarChar(200) // æ“ä½œå¯¹è±¡åç§°ï¼ˆä¾¿äºæŸ¥çœ‹ï¼‰
  changes    Json?                                         // ä¿®æ”¹å†…å®¹ï¼ˆå‰åå¯¹æ¯”JSONï¼‰
  ip         String?  @db.VarChar(45)                      // IPåœ°å€ï¼ˆæ”¯æŒIPv6ï¼‰
  userAgent  String?  @map("user_agent") @db.VarChar(500)  // æµè§ˆå™¨ä¿¡æ¯
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
  @@index([userId])
  @@index([module])
  @@index([action])
  @@index([createdAt])
}

