# 🎯 剩余任务实施方案

## 📋 任务概览

### 剩余任务（4/13）

1. **第10项**: 替换`<img>`为`next/image`（10个文件）
2. **第11项**: 实现精确骨架屏
3. **第12项**: 实现缓存策略（SWR）
4. **第13项**: 添加单元测试

---

## 🔍 任务10：替换img为next/image（工作量评估）

### 需要修改的文件（10个）

**优先级高（用户可见）：**
1. ✅ `src/components/common/ImageWithFallback.tsx` - 已有fallback逻辑
2. ⚠️ `src/components/layout/TopNav.tsx` - 顶部导航Logo
3. ⚠️ `src/app/admin/websites/page.tsx` - 网站列表
4. ⚠️ `src/app/admin/articles/page.tsx` - 文章列表
5. ⚠️ `src/app/admin/media/page.tsx` - 媒体库

**优先级中（管理后台）：**
6. ⚠️ `src/components/admin/MediaSelector.tsx` - 媒体选择器
7. ⚠️ `src/components/common/GlobalSearch.tsx` - 全局搜索
8. ⚠️ `src/app/settings/page.tsx` - 个人设置

**优先级低（测试/辅助）：**
9. ⚠️ `src/app/test-upload/page.tsx` - 测试页面
10. ⚠️ `src/components/common/ImageUploader.tsx` - 上传组件

### 替换策略

```tsx
// 修改前
<img src={logoUrl} alt={name} className="w-12 h-12" />

// 修改后
<Image 
  src={logoUrl} 
  alt={name}
  width={48}
  height={48}
  className="w-12 h-12"
  loading="lazy"
/>
```

**预计时间**: 30-40分钟（每个文件3-4分钟）

---

## 🎨 任务11：精确骨架屏

### 用户要求
1. ✅ 骨架屏数量要和实际数据一致（不能8个显示12个）
2. ✅ 大小形状要匹配
3. ✅ 首次加载显示，后续使用缓存不显示

### 实施方案

**方法1：服务端渲染（推荐）**
```tsx
// src/app/page.tsx - 使用SSR
export default async function HomePage() {
  // 服务端直接获取数据，无骨架屏
  const categories = await getCategories()
  return <WebsiteGrid categories={categories} />
}
```

**方法2：动态骨架屏**
```tsx
// 根据分类配置渲染对应数量的骨架屏
{loading && (
  <div className={`grid grid-cols-${category.cardsPerRow} gap-4`}>
    {[...Array(category.websiteCount || 6)].map((_, i) => (
      <WebsiteCardSkeleton 
        key={i} 
        size={category.displayMode} 
      />
    ))}
  </div>
)}
```

**预计时间**: 15分钟

---

## 💾 任务12：SWR缓存策略

### 实施方案

**安装SWR**
```bash
npm install swr
```

**使用示例**
```tsx
import useSWR from 'swr'

function HomePage() {
  const { data, isLoading } = useSWR('/api/websites', {
    revalidateOnFocus: false,  // 切换窗口不重新加载
    revalidateOnReconnect: false,
    dedupingInterval: 60000,  // 60秒内重复请求使用缓存
  })

  // 只有首次加载且无缓存时显示骨架屏
  if (isLoading && !data) {
    return <Skeleton />
  }

  // 有缓存直接显示，无骨架屏
  return <Content data={data} />
}
```

**预计时间**: 20分钟

---

## 🧪 任务13：单元测试

### 测试框架选择

**推荐：Jest + React Testing Library**

**安装**
```bash
npm install --save-dev jest @testing-library/react @testing-library/jest-dom @testing-library/user-event jest-environment-jsdom
```

### 测试覆盖范围

**核心功能测试**：
1. ✅ 认证系统（登录/登出）
2. ✅ API接口（CRUD操作）
3. ✅ 组件渲染（Toast、ToggleSwitch）
4. ✅ 工具函数（auth、config、rate-limit）

**测试示例**
```typescript
// src/__tests__/lib/auth.test.ts
describe('Auth', () => {
  test('generateToken should create valid JWT', () => {
    const payload = { userId: 1, username: 'admin', role: 'admin' }
    const token = generateToken(payload)
    expect(token).toBeTruthy()
    
    const decoded = verifyToken(token)
    expect(decoded?.userId).toBe(1)
  })
})
```

**预计时间**: 30-40分钟

---

## ⏱️ 总时间评估

| 任务 | 预计时间 |
|------|---------|
| 10. 替换img | 30-40分钟 |
| 11. 精确骨架屏 | 15分钟 |
| 12. SWR缓存 | 20分钟 |
| 13. 单元测试 | 30-40分钟 |
| **总计** | **约2小时** |

---

## 🚨 关键决策点

### 需要用户确认：

1. **第10项（替换img）**：
   - 是否要全部替换10个文件？
   - 还是只替换高优先级的5个文件？

2. **第11项（骨架屏）**：
   - 使用SSR方案（无骨架屏，更快）？
   - 还是保留骨架屏但精确匹配？

3. **第12项（缓存）**：
   - 是否安装SWR（新依赖）？
   - 还是使用Next.js自带的缓存？

4. **第13项（测试）**：
   - 测试覆盖范围多大？
   - 只测核心功能还是全面覆盖？

---

## 💡 建议

### 方案A：完整实施（约2小时）
✅ 完成所有13项任务
✅ 代码质量最高
⚠️ 时间较长

### 方案B：优先实施（约1小时）
✅ 第10项：只替换高优先级5个文件
✅ 第11项：使用SSR方案（更简单）
✅ 第12项：使用Next.js缓存（无需新依赖）
✅ 第13项：只测试核心功能（3-5个测试）
✅ 更快完成

### 方案C：分阶段实施
✅ 今天完成第10-11项（性能相关）
✅ 明天完成第12-13项（优化和测试）

---

## 🎯 我的建议

**推荐方案B（优先实施）**，理由：
1. ✅ 性能提升明显（next/image + SSR）
2. ✅ 用户体验改善（无频繁骨架屏）
3. ✅ 核心测试覆盖足够
4. ✅ 1小时内可完成
5. ✅ 后续可随时增量优化

**你的选择是？**
- A：完整实施（2小时）
- B：优先实施（1小时）✅推荐
- C：分阶段实施

或者告诉我你的想法！

