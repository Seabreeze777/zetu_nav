# ç³»ç»Ÿé…ç½®ç®¡ç†åŠŸèƒ½è¯´æ˜

## ğŸ“‹ å·²å®Œæˆçš„å†…å®¹

### 1. âœ… æ ‡ç­¾è”åŠ¨ä¿®å¤
**é—®é¢˜**ï¼šæ ‡ç­¾ç®¡ç†ä¸­çš„æ ‡ç­¾ä¸ç½‘ç«™/æ–‡ç« æ ‡ç­¾æ˜¯å¦è”åŠ¨ï¼Ÿ

**å›ç­”**ï¼š**å·²ç»æ˜¯è”åŠ¨çš„äº†ï¼**

**æ¶æ„**ï¼š
- æ•°æ®åº“æœ‰ç»Ÿä¸€çš„ `Tag` è¡¨
- é€šè¿‡ `WebsiteTag` å…³è”è¡¨è¿æ¥ç½‘ç«™
- é€šè¿‡ `ArticleTag` å…³è”è¡¨è¿æ¥æ–‡ç« 
- åœ¨"æ ‡ç­¾ç®¡ç†"åˆ›å»ºçš„æ ‡ç­¾ï¼Œåœ¨"ç½‘ç«™ç®¡ç†"å’Œ"æ–‡ç« ç®¡ç†"ä¸­éƒ½å¯ä»¥é€‰æ‹©ä½¿ç”¨

**å·²ä¿®å¤**ï¼š
- API ç°åœ¨ä¼šç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾è¢«å¤šå°‘ä¸ªç½‘ç«™å’Œæ–‡ç« ä½¿ç”¨
- æ ‡ç­¾åˆ—è¡¨é¡µé¢æ˜¾ç¤º "ç½‘ç«™æ•°é‡" å’Œ "æ–‡ç« æ•°é‡" ä¸¤åˆ—

---

## ğŸ”§ ç³»ç»Ÿé…ç½®ç®¡ç†ï¼ˆéœ€è¦å®Œæˆï¼‰

### 2. æ•°æ®åº“è¡¨å·²åˆ›å»º

**`SystemConfig` è¡¨ç»“æ„**ï¼š
```prisma
model SystemConfig {
  id          Int      @id @default(autoincrement())
  category    String   // é…ç½®åˆ†ç±»ï¼šcos, site, emailç­‰
  key         String   // é…ç½®é”®å
  value       String   // é…ç½®å€¼
  label       String   // æ˜¾ç¤ºæ ‡ç­¾
  description String?  // é…ç½®è¯´æ˜
  type        String   // è¾“å…¥ç±»å‹ï¼štext, password, number, textarea
  isSecret    Boolean  // æ˜¯å¦æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰
  sortOrder   Int      // æ’åº
}
```

### 3. å¯åœ¨åå°ç®¡ç†çš„é…ç½®é¡¹

#### COS å¯¹è±¡å­˜å‚¨é…ç½®
```javascript
{
  category: 'cos',
  configs: [
    { key: 'SECRET_ID', label: 'SecretId', type: 'text', isSecret: true },
    { key: 'SECRET_KEY', label: 'SecretKey', type: 'password', isSecret: true },
    { key: 'BUCKET', label: 'å­˜å‚¨æ¡¶åç§°', type: 'text' },
    { key: 'REGION', label: 'åœ°åŸŸ', type: 'text', description: 'å¦‚ï¼šap-chengdu' },
  ]
}
```

#### ç½‘ç«™åŸºæœ¬é…ç½®
```javascript
{
  category: 'site',
  configs: [
    { key: 'SITE_NAME', label: 'ç½‘ç«™åç§°', type: 'text' },
    { key: 'SITE_DESCRIPTION', label: 'ç½‘ç«™æè¿°', type: 'textarea' },
    { key: 'SITE_KEYWORDS', label: 'SEOå…³é”®è¯', type: 'textarea' },
    { key: 'FOOTER_TEXT', label: 'é¡µè„šæ–‡å­—', type: 'text' },
    { key: 'ICP_BEIAN', label: 'ICPå¤‡æ¡ˆå·', type: 'text' },
  ]
}
```

#### æ•°æ®åº“é…ç½®ï¼ˆå»ºè®®ä¿ç•™åœ¨.envï¼‰
```javascript
{
  category: 'database',
  configs: [
    { key: 'DATABASE_URL', label: 'æ•°æ®åº“è¿æ¥', type: 'password', isSecret: true },
  ]
}
```

#### é‚®ä»¶é…ç½®ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
```javascript
{
  category: 'email',
  configs: [
    { key: 'SMTP_HOST', label: 'SMTPæœåŠ¡å™¨', type: 'text' },
    { key: 'SMTP_PORT', label: 'SMTPç«¯å£', type: 'number' },
    { key: 'SMTP_USER', label: 'SMTPç”¨æˆ·å', type: 'text' },
    { key: 'SMTP_PASSWORD', label: 'SMTPå¯†ç ', type: 'password', isSecret: true },
  ]
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥éœ€è¦åšçš„äº‹

### Step 1: è§£å†³ Prisma Client ç”Ÿæˆé—®é¢˜

**é—®é¢˜**ï¼šWindows æ–‡ä»¶è¢«é”å®š

**è§£å†³**ï¼š
```bash
# 1. åœæ­¢å¼€å‘æœåŠ¡å™¨ï¼ˆCtrl + Cï¼‰
# 2. æ€æ‰æ‰€æœ‰ Node è¿›ç¨‹
taskkill /F /IM node.exe

# 3. é‡æ–°ç”Ÿæˆ Prisma Client
npx prisma generate

# 4. é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev
```

### Step 2: åˆ›å»ºé…ç½®ç®¡ç† API

éœ€è¦åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š

**`src/app/api/admin/system-config/route.ts`**
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { verifyAuth } from '@/lib/auth'
import prisma from '@/lib/prisma'

// GET - è·å–é…ç½®ï¼ˆæŒ‰åˆ†ç±»ï¼‰
export async function GET(request: NextRequest) {
  const user = await verifyAuth(request)
  if (!user || user.role !== 'admin') {
    return NextResponse.json({ error: 'æ— æƒé™' }, { status: 403 })
  }

  const { searchParams } = new URL(request.url)
  const category = searchParams.get('category')

  const configs = await prisma.systemConfig.findMany({
    where: category ? { category } : undefined,
    orderBy: [{ category: 'asc' }, { sortOrder: 'asc' }],
    select: {
      id: true,
      category: true,
      key: true,
      value: true,
      label: true,
      description: true,
      type: true,
      isSecret: true,
    },
  })

  // å¯¹äºæ•æ„Ÿé…ç½®ï¼Œä¸è¿”å›æ˜æ–‡
  const safeConfigs = configs.map(config => ({
    ...config,
    value: config.isSecret ? '******' : config.value,
  }))

  return NextResponse.json({ success: true, data: safeConfigs })
}

// POST - åˆ›å»ºé…ç½®
export async function POST(request: NextRequest) {
  const user = await verifyAuth(request)
  if (!user || user.role !== 'admin') {
    return NextResponse.json({ error: 'æ— æƒé™' }, { status: 403 })
  }

  const body = await request.json()
  const config = await prisma.systemConfig.create({ data: body })
  return NextResponse.json({ success: true, data: config })
}
```

**`src/app/api/admin/system-config/[id]/route.ts`**
```typescript
// PUT - æ›´æ–°é…ç½®
export async function PUT(request: NextRequest, { params }: { params: { id: string } }) {
  const user = await verifyAuth(request)
  if (!user || user.role !== 'admin') {
    return NextResponse.json({ error: 'æ— æƒé™' }, { status: 403 })
  }

  const body = await request.json()
  const config = await prisma.systemConfig.update({
    where: { id: parseInt(params.id) },
    data: body,
  })

  return NextResponse.json({ success: true, data: config })
}
```

### Step 3: åˆ›å»ºé…ç½®ç®¡ç†é¡µé¢

**åœ¨ AdminLayout æ·»åŠ èœå•é¡¹**ï¼š
```typescript
{
  href: '/admin/system-config',
  label: 'ç³»ç»Ÿé…ç½®',
  icon: 'âš™ï¸',
}
```

**åˆ›å»ºé¡µé¢ `src/app/admin/system-config/page.tsx`**ï¼š
- åˆ†ç±»æ ‡ç­¾é¡µï¼šCOSé…ç½®ã€ç½‘ç«™é…ç½®ã€æ•°æ®åº“é…ç½®ç­‰
- è¡¨å•å±•ç¤ºæ‰€æœ‰é…ç½®é¡¹
- æ•æ„Ÿé…ç½®ç”¨å¯†ç è¾“å…¥æ¡†
- ä¿å­˜æŒ‰é’®æ‰¹é‡æ›´æ–°

### Step 4: é…ç½®è¯»å–é€»è¾‘

**åˆ›å»ºé…ç½®è¯»å–å·¥å…· `src/lib/config.ts`**ï¼š
```typescript
import prisma from '@/lib/prisma'

// é…ç½®ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ï¼‰
const configCache = new Map<string, string>()
let cacheTime = 0
const CACHE_TTL = 60000 // 1åˆ†é’Ÿ

export async function getConfig(category: string, key: string): Promise<string | null> {
  const cacheKey = `${category}:${key}`
  const now = Date.now()

  // æ£€æŸ¥ç¼“å­˜
  if (now - cacheTime < CACHE_TTL && configCache.has(cacheKey)) {
    return configCache.get(cacheKey) || null
  }

  // æŸ¥è¯¢æ•°æ®åº“
  const config = await prisma.systemConfig.findUnique({
    where: { category_key: { category, key } },
  })

  if (config) {
    configCache.set(cacheKey, config.value)
    return config.value
  }

  // é™çº§åˆ°ç¯å¢ƒå˜é‡
  return process.env[key] || null
}

// åˆ·æ–°ç¼“å­˜
export function clearConfigCache() {
  configCache.clear()
  cacheTime = 0
}
```

**ä¿®æ”¹ `src/lib/cos.ts`** ä½¿ç”¨é…ç½®ï¼š
```typescript
import { getConfig } from './config'

const COS_CONFIG = {
  SecretId: await getConfig('cos', 'SECRET_ID') || process.env.COS_SECRET_ID,
  SecretKey: await getConfig('cos', 'SECRET_KEY') || process.env.COS_SECRET_KEY,
  Bucket: await getConfig('cos', 'BUCKET') || process.env.COS_BUCKET,
  Region: await getConfig('cos', 'REGION') || process.env.COS_REGION,
}
```

---

## ğŸ“Œ é…ç½®ç®¡ç†çš„ä¼˜åŠ¿

### âœ… ä½¿ç”¨æ•°æ®åº“ç®¡ç†é…ç½®çš„å¥½å¤„ï¼š
1. **æ— éœ€é‡å¯æœåŠ¡**ï¼šä¿®æ”¹é…ç½®åç«‹å³ç”Ÿæ•ˆï¼ˆæˆ–çŸ­æ—¶é—´å†…ç”Ÿæ•ˆï¼‰
2. **åå°å¯è§†åŒ–ç®¡ç†**ï¼šæ™®é€šç®¡ç†å‘˜ä¹Ÿèƒ½ä¿®æ”¹é…ç½®
3. **é…ç½®å†å²**ï¼šå¯ä»¥è®°å½•é…ç½®ä¿®æ”¹å†å²
4. **ç¯å¢ƒæ— å…³**ï¼šä¸åŒç¯å¢ƒå¯ä»¥ç”¨åŒä¸€ä»½ä»£ç 

### âš ï¸ å“ªäº›é…ç½®åº”è¯¥ä¿ç•™åœ¨ .envï¼š
1. **DATABASE_URL**ï¼šæ•°æ®åº“è¿æ¥ï¼ˆå¦‚æœæ”¾æ•°æ®åº“é‡Œå°±æ­»å¾ªç¯äº†ï¼‰
2. **JWT_SECRET**ï¼šJWTå¯†é’¥ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
3. **NODE_ENV**ï¼šè¿è¡Œç¯å¢ƒï¼ˆproduction/developmentï¼‰

### ğŸ”„ æ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰ï¼š
```typescript
// ä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼Œé™çº§åˆ°ç¯å¢ƒå˜é‡
const secretId = await getConfig('cos', 'SECRET_ID') || process.env.COS_SECRET_ID
```

è¿™æ ·æ—¢æœ‰çµæ´»æ€§ï¼Œåˆæœ‰å®‰å…¨ä¿éšœï¼

---

## ğŸ¯ æ€»ç»“

ä½ æçš„3ä¸ªé—®é¢˜ï¼š

1. **âœ… æ ‡ç­¾è”åŠ¨** - å·²ç»æ˜¯è”åŠ¨çš„ï¼Œå¹¶ä¿®å¤äº†ç»Ÿè®¡æ˜¾ç¤º
2. **âš™ï¸ COSåå°ç®¡ç†** - æ•°æ®åº“è¡¨å·²åˆ›å»ºï¼Œéœ€è¦å®ŒæˆAPIå’Œé¡µé¢
3. **ğŸ“ å…¶ä»–é…ç½®** - å»ºè®®æ··åˆæ–¹æ¡ˆï¼š
   - æ•æ„Ÿ/åŸºç¡€é…ç½®ï¼ˆæ•°æ®åº“ã€JWTï¼‰ï¼šä¿ç•™åœ¨ `.env`
   - ä¸šåŠ¡é…ç½®ï¼ˆCOSã€ç½‘ç«™ä¿¡æ¯ï¼‰ï¼šå¯åœ¨åå°ç®¡ç†
   - ç³»ç»Ÿè‡ªåŠ¨é™çº§ï¼šå…ˆæŸ¥æ•°æ®åº“ï¼ŒæŸ¥ä¸åˆ°ç”¨ç¯å¢ƒå˜é‡

**ä¸‹ä¸€æ­¥**ï¼š
1. é‡å¯æœåŠ¡å™¨è§£å†³æ–‡ä»¶é”
2. åˆ›å»ºé…ç½®ç®¡ç†API
3. åˆ›å»ºé…ç½®ç®¡ç†é¡µé¢
4. åˆå§‹åŒ–é»˜è®¤é…ç½®

éœ€è¦æˆ‘ç»§ç»­å¸®ä½ å®ç°é…ç½®ç®¡ç†çš„å®Œæ•´ä»£ç å—ï¼Ÿ

